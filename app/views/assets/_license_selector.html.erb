<% default_license ||= 'CC-BY-4.0' %>
<% accessor ||= :license %>
<% selected_license = resource.send(accessor) %>
<% selected_license = (resource.new_record? ? default_license : Seek::License::NULL_LICENSE) if selected_license.nil? %>
<% label ||= 'License' %>

<%= folding_panel(label, false,
                  :help_text => "Here you can choose which license this #{text_for_resource(resource)} is available under.") do %>
    <div class="form-group" id="license-section">
      <label><%= label %></label>

      <%= grouped_license_select("#{resource.class.name.underscore}[#{accessor.to_s}]", selected_license,
                                 :id => 'license-select', :class => 'form-control',
                                 :source => Seek::License::OPENDEFINITION[:data]) %>

      <span class="help-block license-url-block">
        For more information on this license, please visit <a id="license-url" href="" target="_blank"></a>
      </span>
    </div>
<% end %>

<script>
    $j(document).ready(function () {
        $j('#license-select').change(zenodoExport.setLicenseUrl); // Set URL on user change
        zenodoExport.setLicenseUrl(); // Set URL on initial page load
    });

    <% if resource_for_controller && resource_for_controller.new_record? %>
    //  this is to handle auto selecting the default license for a project, when the project is selected
    //  it only occurs for new records, not when being edited.
        $j(document).ready(function () {

            <%
                projects=current_user.person.projects.select{|proj| proj.default_license}
                licences={}
                projects.each{|proj| licences[proj.id]=proj.default_license}
                license_json=licences.to_json.html_safe

            %>
            var projectLicenses = JSON.parse('<%= license_json %>');

            var projectSelectID = '#<%= controller_name.singularize %>_project_ids';

            $j(projectSelectID).on('change', function () {
                var ids = $j(this).val();
                if (ids != null) {
                    var license = projectLicenses[ids.first()]
                    if (license != null) {
                        $j('#license-select').val(license);
                    }
                }
            });

            //trigger an initial change event, as an project may have been added before this elements loads
            $j(projectSelectID).trigger('change');
        });
    <% end %>
</script>
